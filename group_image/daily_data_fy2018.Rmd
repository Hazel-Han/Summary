# Data prepartion
```{r}
#read data and pre-prepartion
library(data.table)
library(dplyr)
library(stringr)
days_between = fread('C:/Users/zhan/Documents/days_between_full_MM_corrected_new.csv')
days_between$EXPRESS_NUMBER = str_pad(days_between$EXPRESS_NUMBER, width=6, side="left", pad="0") 
days_between$V1 <- NULL
days_between2017 = days_between[days_between$year == 2017]
days_between2017 = days_between2017[days_between2017$month >9]
days_between2018 = days_between[days_between$year == 2018]
days_between2018 = days_between2018[days_between2018$month < 10]
days_between = rbind(days_between2017,days_between2018)


seg = fread('C:/Users/zhan/Documents/SEGMENTATION_OCT16.csv')

top10_count = fread('C:/Users/zhan/Documents/month_top10.csv')
fund_per = fread('C:/Users/zhan/Documents/monthly_fund_perf.csv')
fund_per$EXPRESS_NUMBER = str_pad(fund_per$EXPRESS_NUMBER, width=6, side="left", pad="0") 
fund_per$vs_1y = ifelse(fund_per$vs_1y > 0,1,0)
fund_per$vs_3m = ifelse(fund_per$vs_3m > 0,1,0)

month = fread('C:/Users/zhan/Documents/month_activity.csv')
DSP = fread('C:/Users/zhan/Documents/DSP_DATASET1026.csv')
DSP <- DSP %>%select(Territory, EXPRESS, DEALER_NAME,FIRM_NAME,CITY, STATE, DO_NOT_CALL,DO_NOT_SCHEDULE, DO_NOT_EMAIL, DO_NOT_FAX, DO_NOT_MAIL, DO_NOT_VISIT) 
age = fread('C:/Users/zhan/Documents/age_and_channel_variable.csv')
colnames(age) <- as.character(unlist(age[1,]))
age$EXPRESS = str_pad(age$EXPRESS, width=6, side="left", pad="0") 

#merge dataset
monthly <- merge(month,DSP, by = 'EXPRESS' )
monthly <- merge(monthly,age,by = c('EXPRESS'))
monthly <- merge(top10_count,monthly,by.x = c('EXPRESS_NUMBER','month'),by.y = c('EXPRESS','month'),all.y=T)
monthly$V1 <- NULL
monthly$top10_count[is.na(monthly$top10_count)] <- 0
monthly <- merge(monthly,fund_per,by = c('EXPRESS_NUMBER','month'),all.x = T)
library(zoo)
monthly <-merge(monthly,seg,by.x='EXPRESS_NUMBER',by.y='EXPRESS')
monthly <- merge(monthly,days_between,by = c('EXPRESS_NUMBER','month'))

#Fill na of fund performance with average of itself or whole column
monthly$FUND_AVG_ANNUAL_RET_1YR <- with(monthly, ave(FUND_AVG_ANNUAL_RET_1YR, EXPRESS_NUMBER, FUN = na.aggregate))
monthly$FUND_AVG_ANNUAL_RET_1YR[is.nan(monthly$FUND_AVG_ANNUAL_RET_1YR)] <- 0
monthly$FUND_AVG_ANNUAL_RET_1YR <- ifelse(monthly$FUND_AVG_ANNUAL_RET_1YR == 0, mean(monthly$FUND_AVG_ANNUAL_RET_1YR),monthly$FUND_AVG_ANNUAL_RET_1YR)

monthly$FUND_CUMULATIVE_RET_3MTH <- with(monthly, ave(FUND_CUMULATIVE_RET_3MTH, EXPRESS_NUMBER, FUN = na.aggregate))
monthly$FUND_CUMULATIVE_RET_3MTH[is.nan(monthly$FUND_CUMULATIVE_RET_3MTH)] <- 0
monthly$FUND_CUMULATIVE_RET_3MTH <- ifelse(monthly$FUND_CUMULATIVE_RET_3MTH == 0, mean(monthly$FUND_CUMULATIVE_RET_3MTH),monthly$FUND_CUMULATIVE_RET_3MTH)

monthly$vs_1y <- with(monthly, ave(vs_1y, EXPRESS_NUMBER, FUN = na.aggregate))
monthly$vs_1y[is.nan(monthly$vs_1y)] <- 0
monthly$vs_1y <- ifelse(monthly$vs_1y == 0, mean(monthly$vs_1y),monthly$vs_1y)

monthly$vs_3m <- with(monthly, ave(vs_3m, EXPRESS_NUMBER, FUN = na.aggregate))
monthly$vs_3m[is.nan(monthly$vs_3m)] <- 0
monthly$vs_3m <- ifelse(monthly$vs_3m == 0, mean(monthly$vs_3m),monthly$vs_3m)


#create, normalize variables
monthly$no_email <- ifelse(monthly$DO_NOT_EMAIL == 'Y',1,0)
monthly$no_call <- ifelse(monthly$DO_NOT_CALL == 'Y',1,0)
monthly$no_visit <- ifelse(monthly$DO_NOT_VISIT == 'Y',1,0)
monthly$no_fax <- ifelse(monthly$DO_NOT_FAX == 'Y',1,0)
monthly$no_mail <- ifelse(monthly$DO_NOT_MAIL == 'Y',1,0)

monthly$factor_terr<-as.factor(monthly$Territory)
TERR <- monthly%>%group_by(Territory)%>%summarise(avg_count = n())
TERR<-TERR[order(-TERR$avg_count),]
lis = data.frame(TERR[1:50,]['Territory'])
lis = c(lis$Territory)
monthly$TERR <- str_extract(monthly$Territory, paste(lis, collapse="|"))
monthly$TERR <- ifelse(is.na(monthly$TERR)== T,0,1)

monthly$log_total_sale <- log(1+monthly$total_sale)
monthly$log_TRADE_COUNT <- log(1+monthly$total_trade_count)
monthly$log_TOTAL_UOPEN <- log(1+monthly$TOTAL_UOPEN)
monthly$log_PAGE_VIEWS <- log(1+monthly$PAGE_VIEWS)
monthly$log_INBOUND_CALL_VAC_Q1Q218 <- log(1+monthly$total_inbound)
monthly$log_OUTBOUND_CALL_VAC_Q1Q218 <- log(1+monthly$total_outbound)
monthly$log_VISIT_VAC_Q1Q218 <- log(1+monthly$total_visit)
monthly$log_uclick <- log(1+monthly$TOTAL_UCLICK)
monthly$sent_click_ratio <- monthly$TOTAL_UCLICK/monthly$TOTAL_SENT
monthly$sent_click_ratio[is.na(monthly$sent_click_ratio)] <- 0
```
# Oct test data
```{r}
days_between_oct = fread('C:/Users/zhan/Documents/days_between_full_MM_corrected_new.csv')
days_between_oct$EXPRESS_NUMBER = str_pad(days_between_oct$EXPRESS_NUMBER, width=6, side="left", pad="0")
days_between_oct$V1 <- NULL
days_between_oct = days_between_oct[days_between_oct$year == 2018]
days_between_oct = days_between_oct[days_between_oct$month == 10]

oct_test = fread('C:/Users/zhan/Documents/Oct.csv')
oct_test$EXPRESS_NUMBER = str_pad(oct_test$EXPRESS_NUMBER, width=6, side="left", pad="0")

oct <- merge(oct_test,DSP, by.x = 'EXPRESS_NUMBER',by.y='EXPRESS' )
oct <- merge(oct,age,by.x = 'EXPRESS_NUMBER',by.y='EXPRESS')
oct <-merge(oct,seg,by.x='EXPRESS_NUMBER',by.y='EXPRESS')
oct <- merge(oct,days_between_oct,by = c('EXPRESS_NUMBER','month'))

#create, normalize variables
oct$month <-10
oct$factor_terr<-as.factor(oct$Territory)
oct$no_email <- ifelse(oct$DO_NOT_EMAIL == 'Y',1,0)
oct$no_call <- ifelse(oct$DO_NOT_CALL == 'Y',1,0)
oct$no_visit <- ifelse(oct$DO_NOT_VISIT == 'Y',1,0)
oct$no_fax <- ifelse(oct$DO_NOT_FAX == 'Y',1,0)
oct$no_mail <- ifelse(oct$DO_NOT_MAIL == 'Y',1,0)
TERR <- oct%>%group_by(Territory)%>%summarise(avg_count = n())
TERR<-TERR[order(-TERR$avg_count),]
lis = data.frame(TERR[1:50,]['Territory'])
lis = c(lis$Territory)
oct$TERR <- str_extract(oct$Territory, paste(lis, collapse="|"))
oct$TERR <- ifelse(is.na(oct$TERR)== T,0,1)
oct$log_total_sale <- log(1+oct$oct_sale)
oct$log_TRADE_COUNT <- log(1+oct$oct_trade_count)
oct$log_INBOUND_CALL_VAC_Q1Q218 <- log(1+oct$inbound_avg)
oct$log_OUTBOUND_CALL_VAC_Q1Q218 <- log(1+oct$total_outbound)
oct$log_VISIT_VAC_Q1Q218 <- log(1+oct$total_visit)

#fill na with last quarter
unique_inbound <- monthly[(monthly$month==7)|(monthly$month==8)|(monthly$month==9)]
unique_inbound<- setDT(unique_inbound)[, inbound_avg := mean(total_inbound), by = 'EXPRESS_NUMBER']
unique_inbound <- unique_inbound[!duplicated(unique_inbound[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','inbound_avg')
oct <- merge(oct,unique_inbound,by='EXPRESS_NUMBER',all.x = T)

unique_FUND_AVG_ANNUAL_RET_1YR <- monthly[(monthly$month==7)|(monthly$month==8)|(monthly$month==9)]
unique_FUND_AVG_ANNUAL_RET_1YR<- setDT(unique_FUND_AVG_ANNUAL_RET_1YR)[, FUND_AVG_ANNUAL_RET_1YR_avg := mean(FUND_AVG_ANNUAL_RET_1YR), by = 'EXPRESS_NUMBER']
unique_FUND_AVG_ANNUAL_RET_1YR <- unique_FUND_AVG_ANNUAL_RET_1YR[!duplicated(unique_FUND_AVG_ANNUAL_RET_1YR[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','FUND_AVG_ANNUAL_RET_1YR_avg')
oct <- merge(oct,unique_FUND_AVG_ANNUAL_RET_1YR,by='EXPRESS_NUMBER',all.x = T)

unique_FUND_CUMULATIVE_RET_3MTH <- monthly[(monthly$month==7)|(monthly$month==8)|(monthly$month==9)]
unique_FUND_CUMULATIVE_RET_3MTH<- setDT(unique_FUND_CUMULATIVE_RET_3MTH)[, FUND_CUMULATIVE_RET_3MTH_avg := mean(FUND_CUMULATIVE_RET_3MTH), by = 'EXPRESS_NUMBER']
unique_FUND_CUMULATIVE_RET_3MTH <- unique_FUND_CUMULATIVE_RET_3MTH[!duplicated(unique_FUND_CUMULATIVE_RET_3MTH[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','FUND_CUMULATIVE_RET_3MTH_avg')
oct <- merge(oct,unique_FUND_CUMULATIVE_RET_3MTH,by='EXPRESS_NUMBER',all.x = T)

unique_vs_1y <- monthly[(monthly$month==7)|(monthly$month==8)|(monthly$month==9)]
unique_vs_1y<- setDT(unique_vs_1y)[, vs_1y_avg := mean(vs_1y), by = 'EXPRESS_NUMBER']
unique_vs_1y <- unique_vs_1y[!duplicated(unique_vs_1y[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','vs_1y_avg')
oct <- merge(oct,unique_vs_1y,by='EXPRESS_NUMBER',all.x = T)

unique_vs_3m <- monthly[(monthly$month==7)|(monthly$month==8)|(monthly$month==9)]
unique_vs_3m<- setDT(unique_vs_3m)[, vs_3m_avg := mean(vs_3m), by = 'EXPRESS_NUMBER']
unique_vs_3m <- unique_vs_3m[!duplicated(unique_vs_3m[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','vs_3m_avg')
oct <- merge(oct,unique_vs_3m,by='EXPRESS_NUMBER',all.x = T)

unique_top10_count <- monthly[(monthly$month==7)|(monthly$month==8)|(monthly$month==9)]
unique_top10_count<- setDT(unique_top10_count)[, top10_count_avg := mean(total_top10_count), by = 'EXPRESS_NUMBER']
unique_top10_count <- unique_top10_count[!duplicated(unique_top10_count[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','top10_count_avg')
oct <- merge(oct,unique_top10_count,by='EXPRESS_NUMBER',all.x = T)

unique_PAGE_VIEWS <- monthly[(monthly$month==7)|(monthly$month==8)|(monthly$month==9)]
unique_PAGE_VIEWS<- setDT(unique_PAGE_VIEWS)[, PAGE_VIEWS_avg := mean(PAGE_VIEWS), by = 'EXPRESS_NUMBER']
unique_PAGE_VIEWS <- unique_PAGE_VIEWS[!duplicated(unique_PAGE_VIEWS[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','PAGE_VIEWS_avg')
oct <- merge(oct,unique_PAGE_VIEWS,by='EXPRESS_NUMBER',all.x = T)

unique_TOTAL_UCLICK <- monthly[(monthly$month==7)|(monthly$month==8)|(monthly$month==9)]
unique_TOTAL_UCLICK<- setDT(unique_TOTAL_UCLICK)[, TOTAL_UCLICK_avg := mean(TOTAL_UCLICK), by = 'EXPRESS_NUMBER']
unique_TOTAL_UCLICK <- unique_TOTAL_UCLICK[!duplicated(unique_TOTAL_UCLICK[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','TOTAL_UCLICK_avg')
oct <- merge(oct,unique_TOTAL_UCLICK,by='EXPRESS_NUMBER',all.x = T)

oct$sent_click_ratio <- ifelse(oct$TOTAL_SENT==0,0,oct$TOTAL_UCLICK_avg/oct$TOTAL_SENT)
oct$sent_click_ratio[is.na(oct$sent_click_ratio)] <- 0
```

##fill with avg
monthly<- setDT(monthly)[, inbound_avg := mean(total_inbound), by = 'EXPRESS_NUMBER']
unique_inbound <- monthly[!duplicated(monthly[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','inbound_avg')
oct <- merge(oct,unique_inbound,by='EXPRESS_NUMBER',all.x = T)

monthly<- setDT(monthly)[, FUND_AVG_ANNUAL_RET_1YR_avg := mean(FUND_AVG_ANNUAL_RET_1YR), by = 'EXPRESS_NUMBER']
unique_FUND_AVG_ANNUAL_RET_1YR <- monthly[!duplicated(monthly[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','FUND_AVG_ANNUAL_RET_1YR_avg')
oct <- merge(oct,unique_FUND_AVG_ANNUAL_RET_1YR,by='EXPRESS_NUMBER',all.x = T)

monthly<- setDT(monthly)[, FUND_CUMULATIVE_RET_3MTH_avg := mean(FUND_CUMULATIVE_RET_3MTH), by = 'EXPRESS_NUMBER']
unique_FUND_CUMULATIVE_RET_3MTH <- monthly[!duplicated(monthly[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','FUND_CUMULATIVE_RET_3MTH_avg')
oct <- merge(oct,unique_FUND_CUMULATIVE_RET_3MTH,by='EXPRESS_NUMBER',all.x = T)

monthly<- setDT(monthly)[, vs_1y_avg := mean(vs_1y), by = 'EXPRESS_NUMBER']
unique_vs_1y <- monthly[!duplicated(monthly[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','vs_1y_avg')
oct <- merge(oct,unique_vs_1y,by='EXPRESS_NUMBER',all.x = T)

monthly<- setDT(monthly)[, vs_3m_avg := mean(vs_3m), by = 'EXPRESS_NUMBER']
unique_vs_3m <- monthly[!duplicated(monthly[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','vs_3m_avg')
oct <- merge(oct,unique_vs_3m,by='EXPRESS_NUMBER',all.x = T)

monthly<- setDT(monthly)[, top10_count_avg := mean(top10_count), by = 'EXPRESS_NUMBER']
unique_top10_count <- monthly[!duplicated(monthly[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','top10_count_avg')
oct <- merge(oct,unique_top10_count,by='EXPRESS_NUMBER',all.x = T)

monthly<- setDT(monthly)[, PAGE_VIEWS_avg := mean(PAGE_VIEWS), by = 'EXPRESS_NUMBER']
unique_PAGE_VIEWS <- monthly[!duplicated(monthly[,c('EXPRESS_NUMBER')]),]%>%select('EXPRESS_NUMBER','PAGE_VIEWS_avg')

## fill with last oct
unique_inbound <- monthly[monthly$month==10]%>%select('EXPRESS_NUMBER','total_inbound')
oct <- merge(oct,unique_inbound,by='EXPRESS_NUMBER',all.x = T)
unique_FUND_AVG_ANNUAL_RET_1YR <- monthly[monthly$month==10]%>%select('EXPRESS_NUMBER','FUND_AVG_ANNUAL_RET_1YR')
oct <- merge(oct,unique_FUND_AVG_ANNUAL_RET_1YR,by='EXPRESS_NUMBER',all.x = T)
unique_FUND_CUMULATIVE_RET_3MTH <- monthly[monthly$month==10]%>%select('EXPRESS_NUMBER','FUND_CUMULATIVE_RET_3MTH')
oct <- merge(oct,unique_FUND_CUMULATIVE_RET_3MTH,by='EXPRESS_NUMBER',all.x = T)
unique_vs_1y <- monthly[monthly$month==10]%>%select('EXPRESS_NUMBER','vs_1y')
oct <- merge(oct,unique_vs_1y,by='EXPRESS_NUMBER',all.x = T)
unique_vs_3m <- monthly[monthly$month==10]%>%select('EXPRESS_NUMBER','vs_3m')
oct <- merge(oct,unique_vs_3m,by='EXPRESS_NUMBER',all.x = T)
unique_top10_count <- monthly[monthly$month==10]%>%select('EXPRESS_NUMBER','top10_count')
oct <- merge(oct,unique_top10_count,by='EXPRESS_NUMBER',all.x = T)
unique_PAGE_VIEWS <- monthly[monthly$month==10]%>%select('EXPRESS_NUMBER','PAGE_VIEWS')
oct <- merge(oct,unique_PAGE_VIEWS,by='EXPRESS_NUMBER',all.x = T)
```{r}
#split monthly to top10 and other firm
top10 <- monthly[FIRM_NAME.x %like% "EDWARD JONES" | FIRM_NAME.x %like% 'MERRILL LYNCH'| FIRM_NAME.x %like% 'WELLS FARGO'| FIRM_NAME.x %like% 'LPL FINANCIAL'| FIRM_NAME.x %like% 'MORGAN STANLEY'| FIRM_NAME.x %like% 'RAYMOND'| FIRM_NAME.x %like% 'AMERIPRISE'| FIRM_NAME.x %like% 'UBS FINANCIAL'| FIRM_NAME.x %like% 'CETERA'| FIRM_NAME.x %like% 'MSCS FINANCIAL SERVICES LLC']

library(dplyr)
top10$order <- factor(top10$month,levels = c(10,11,12,1,2,3,4,5,6,7,8,9))
top10 <- top10[order(EXPRESS_NUMBER,order)]

avg_sale = mean(top10$total_sale)
top10$over_avg <- ifelse(top10$total_sale > avg_sale,1,0)
write.csv(top10,'C:/Users/zhan/Documents/top_10_daily.csv')


other_firm <-monthly[!top10]
other_firm$order <- factor(other_firm$month,levels = c(10,11,12,1,2,3,4,5,6,7,8,9))
other_firm <- other_firm[order(EXPRESS_NUMBER,order)]

avg_sale = mean(other_firm$total_sale)
other_firm$over_avg <- ifelse(other_firm$total_sale > avg_sale,1,0)
#write.csv(other_firm,'C:/Users/zhan/Documents/other_firm_original.csv')
write.csv(other_firm,'C:/Users/zhan/Documents/other_firm_daily.csv')
```
# Split test data
# oct_test_top&other
```{r}
top10_test <- oct[FIRM_NAME.x %like% "EDWARD JONES" | FIRM_NAME.x %like% 'MERRILL LYNCH'| FIRM_NAME.x %like% 'WELLS FARGO'| FIRM_NAME.x %like% 'LPL FINANCIAL'| FIRM_NAME.x %like% 'MORGAN STANLEY'| FIRM_NAME.x %like% 'RAYMOND'| FIRM_NAME.x %like% 'AMERIPRISE'| FIRM_NAME.x %like% 'UBS FINANCIAL'| FIRM_NAME.x %like% 'CETERA'| FIRM_NAME.x %like% 'MSCS FINANCIAL SERVICES LLC']

write.csv(top10_test,'C:/Users/zhan/Documents/top_10_daily_test.csv')


other_firm_test <-oct[!top10_test]
write.csv(other_firm_test,'C:/Users/zhan/Documents/other_firm_daily_test.csv')
```